(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{23:function(e,t,i){var n;void 0===(n=function(e,t){"use strict";return{BASEMAP:"dulieunen",SAUBENH:"SauBenh",DOANHNGHIEP:"DoanhNghiep",TRONGTROT:"TrongTrot",INDEX_HANHCHINHXA:4,INDEX_HANHCHINHHUYEN:5,TABLE_SXTT_URL:"https://ditagis.com:6443/arcgis/rest/services/BinhDuong/BaoVeThucVat/FeatureServer/3",THOI_GIAN_SAN_XUAT_TRONG_TROT:"thoigiansxtt",TBL_GIAI_DOAN_SINH_TRUONG:"tblgiaidoansinhtruong"}}.apply(t,[i,t]))||(e.exports=n)},26:function(e,t,i){var n;void 0===(n=function(e,t){"use strict";return{basemap:{title:"Dữ liệu nền",id:"dulieunen",url:"https://ditagis.com:6443/arcgis/rest/services/BinhDuong/DuLieuNen/MapServer",visible:!0,copyright:"Bản đồ biên tập bởi Trung tâm DITAGIS",sublayers:[{id:5,title:"Hành chính huyện"},{id:4,title:"Hành chính xã"},{id:3,title:"Sông hồ"},{id:2,title:"Phủ bề mặt",visible:!1},{id:1,title:"Mặt giao thông"},{id:0,title:"Tim đường"}]},layers:[{title:"Trồng trọt",id:"TrongTrot",url:"https://ditagis.com:6443/arcgis/rest/services/BinhDuong/BaoVeThucVat_ChuyenDe/FeatureServer/2",outFields:["*"]},{title:"Sâu bệnh",id:"SauBenh",url:"https://ditagis.com:6443/arcgis/rest/services/BinhDuong/BaoVeThucVat_ChuyenDe/FeatureServer/1",outFields:["*"]},{title:"Doanh nghiệp",id:"DoanhNghiep",url:"https://ditagis.com:6443/arcgis/rest/services/BinhDuong/BaoVeThucVat_ChuyenDe/FeatureServer/0",outFields:["*"]}],tables:[{id:"thoigiansxtt",url:"https://ditagis.com:6443/arcgis/rest/services/BinhDuong/BaoVeThucVat_ChuyenDe/FeatureServer/3"},{id:"tblgiaidoansinhtruong",url:"https://ditagis.com:6443/arcgis/rest/services/BinhDuong/BaoVeThucVat_ChuyenDe/FeatureServer/4"}],zoom:10,center:[106.6843694,11.158752270428375]}}.apply(t,[i,t]))||(e.exports=n)},30:function(e,t,i){var n,a;n=[i,t,i(51)],void 0===(a=function(e,t,i){"use strict";return class{constructor(){this.eventListener=new i(this)}}}.apply(t,n))||(e.exports=a)},38:function(e,t,i){var n,a,r=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){e.done?a(e.value):new i(function(t){t(e.value)}).then(o,s)}l((n=n.apply(e,t||[])).next())})};n=[i,t,i(23),i(26),i(0),i(1),i(59),i(43),i(50),i(53),i(5),i(2),i(3),i(49),i(25)],void 0===(a=function(e,t,i,n,a,o,s,l,d,h,c,u,p,m,g){"use strict";return class{constructor(e){this.view=e,this.options={hightLength:100};let t=n.tables.find(function(e){return e.id===i.THOI_GIAN_SAN_XUAT_TRONG_TROT}).url;this.thoiGianSanXuatTrongTrot=new m({url:t,fieldID:"MaDoiTuong"}),this.popupEdit=new s(e,{hightLength:this.options.hightLength,table:this.thoiGianSanXuatTrongTrot}),this.tblGiaiDoanSinhTruong=new m({url:n.tables.find(e=>e.id===i.TBL_GIAI_DOAN_SINH_TRUONG).url,fieldID:"OBJECTID"}),this.hightlightGraphic=new l(e,{symbolMarker:new c({outline:new p({color:new g("#7EABCD"),width:2})}),symbolFill:new u({outline:new p({color:new g("#7EABCD"),width:2})})})}startup(){this.view.map.layers.map(e=>{e.then(()=>{if("feature"==e.type){let t=[];e.permission.edit&&t.push({id:"update",title:"Cập nhật",className:"esri-icon-edit",layer:e}),e.permission.delete&&t.push({id:"delete",title:"Xóa",className:"esri-icon-erase",layer:e}),e.id===i.TRONGTROT&&("/cattachthua"!==location.pathname&&t.push({id:"view-detail",title:"Chi tiết thời gian trồng trọt",className:"esri-icon-table",layer:e}),"/congtacvien"!==location.pathname&&(t.push({id:"split",title:"Chia thửa",className:"esri-icon-zoom-out-fixed",layer:e}),t.push({id:"merge",title:"Ghép thửa",className:"esri-icon-zoom-in-fixed",layer:e}))),e.popupTemplate={content:t=>{Loader.show(!1);let i=this.contentPopup(t,e);return Loader.hide(),i},title:e.title,actions:t}}})}),this.view.popup.watch("visible",e=>{e||this.hightlightGraphic.clear()}),this.view.popup.on("trigger-action",e=>{this.triggerActionHandler(e)}),this.view.popup.dockOptions={buttonEnabled:!0,breakpoint:{width:600,height:1e3},position:"bottom-center"}}get selectFeature(){return this.view.popup.viewModel.selectedFeature}get layer(){return this.selectFeature.layer}get attributes(){return this.selectFeature.attributes}get objectId(){return this.attributes.OBJECTID}triggerActionHandler(e){let t=e.action.id,i=this.layer||e.action.layer;this.popupEdit.layer=i;let n=!1;switch(t){case"update":i.permission&&i.permission.edit?"esri-icon-check-mark"===e.action.className?this.popupEdit.editFeature():this.popupEdit.showEdit():n=!0;break;case"delete":i.permission&&i.permission.delete?this.popupEdit.deleteFeature():n=!0;break;case"view-detail":this.attributes.MaDoiTuong?this.triggerActionViewDetailTrongtrot(this.attributes.MaDoiTuong):$.notify({message:"Không xác được định danh"},{type:"danger"});break;case"view-detail-edit":this.attributes.MaDoiTuong?this.popupEdit.showTableDetailTrongTrot():$.notify({message:"Không xác được định danh"},{type:"danger"});break;case"update-geometry":if("polygon"===i.geometryType){alert("Không thể thay đổi vị trí vùng...");break}this.popupEdit.updateGeometryGPS();break;case"split":this.popupEdit.splitPolygon();break;case"merge":this.popupEdit.mergePolygon()}n&&$.notify({message:"Không có quyền thực hiện tác vụ"},{type:"danger"})}getSubtype(e,t){return e=e||this.layer.typeIdField,t=t||this.attributes[e],this.tblGiaiDoanSinhTruong.typeIdField===e?(this.tblGiaiDoanSinhTruong.typeIdField,this.tblGiaiDoanSinhTruong.types.find(e=>e.id==t)):null}renderDomain(e,t){let i;if("inherited"===e.type){let e=this.layer.getFieldDomain(t);e&&(i=e.codedValues)}else i=e.codedValues;return i}contentPopup(e,t){return r(this,void 0,void 0,function*(){try{const i=e.graphic,n=i.layer||t,s=i.attributes;i.layer||(i.layer=n),this.hightlightGraphic.clear(),this.hightlightGraphic.add(i);let l=o.create("div",{class:"popup-content",id:"popup-content"}),c=o.create("table",{},l),u=this.getSubtype();for(let e of n.fields){let t=s[e.name];if("oid"===e.type)continue;let i,n,a,l=o.create("tr"),h=o.create("td",{innerHTML:e.alias});if(u&&u.domains[e.name]?a=this.renderDomain(u.domains[e.name],e.name):e.domain&&(a=this.renderDomain(e.domain,e.name)),a){let e=a.find(e=>e.code===t);e&&(t=e.name)}else if("MaPhuongXa"!==e.name&&"MaHuyenTP"!==e.name||!s[e.name])"small-integer"===e.type||"integer"===e.type||"double"===e.type||"date"===e.type&&(n="DateFormat");else{let i=yield d.getLocationName(this.view,{PhuongXa:s.MaPhuongXa,HuyenTP:s.MaHuyenTP}).then(e=>r(this,void 0,void 0,function*(){return yield e}));t="MaPhuongXa"==e.name?i.TenPhuong:i.TenHuyen}i=n?`{${e.name}:${n}}`:t;let p=o.create("td");e.length>=this.options.hightLength?o.create("textarea",{rows:5,cols:25,readonly:!0,innerHTML:i,style:"background: transparent;border:none"},p):p.innerHTML=i,o.place(h,l),o.place(p,l),o.place(l,c)}return n.hasAttachments&&n.getAttachments(s.OBJECTID).then(e=>{if(e&&e.attachmentInfos&&e.attachmentInfos.length>0){let t=o.create("div",{class:"attachment-container"},document.getElementById("popup-content"));o.create("legend",{innerHTML:"Hình ảnh"},t);let i=`${n.url}/${n.layerId}/${s.OBJECTID}`;for(let n of e.attachmentInfos){let e=o.create("div",{class:"col-lg-3 col-md-4 col-xs-6 thumb"},t),r=o.create("a",{class:"thumbnail",href:"javascript:void(0)"},e),s=o.create("img",{class:"img-responsive",id:`${i}/attachments/${n.id}`,src:`${i}/attachments/${n.id}`,alt:`${i}/attachments/${n.name}`},r);a(r,"click",()=>{let e=h.modal(`attachments-${n.id}`,n.name,s.cloneNode(!0));e&&e.modal()})}}}),l.outerHTML}catch(e){throw e}})}triggerActionViewDetailTrongtrot(e){let t=$.notify({title:"Thời gian trồng trọt thửa đất: "+e,message:"Đang truy vấn..."},{delay:2e4,showProgressbar:!0});this.thoiGianSanXuatTrongTrot.findById(e).then(e=>{if(e.features.length>0){t.update("message",`Tìm thấy ${e.features.length} dữ liệu`),t.update("progress",100),t.update("type","success");let i=document.createElement("table");i.classList.add("table","table-hover");let n=document.createElement("thead");n.innerHTML="<tr>\n              <th>Nhóm cây trồng</th>\n              <th>Loại cây trồng</th>\n              <th>Diện tích</th>\n              <th>Thời gian bắt đầu trồng</th>\n              <th>Thời gian trồng trọt</th>\n              <th>Giai đoạn sinh trưởng</th>\n            </tr>\n            </thead>",o.place(n,i),i.appendChild(n);let a=document.createElement("tbody");i.appendChild(a);let r=e.features.sort(function(e,t){let i=e.attributes,n=t.attributes;return i.Nam==n.Nam?i.Thang>n.Thang:i.Nam>n.Nam});for(let e of r){const t=e.attributes;let i=document.createElement("tr");i.classList.add("Info"),a.appendChild(i);let n=document.createElement("td"),r=this.layer.getFieldDomain("NhomCayTrong").codedValues;if(r){let e=r.find(e=>e.code==t.NhomCayTrong);e&&(n.innerText=e.name)}n.innerText||(n.innerText=t.NhomCayTrong+""||"");let o=document.createElement("td"),s=this.getSubtype("NhomCayTrong",t.NhomCayTrong);if(!s)return;let l=s.domains.LoaiCayTrong;if(l){let e;if("inherited"===l.type){let t=this.layer.getFieldDomain("LoaiCayTrong");t&&(e=t.codedValues)}else e=l.codedValues;if(e){let i=e.find(e=>e.code==t.LoaiCayTrong);i&&(o.innerText=i.name)}}o.innerText||(o.innerText=t.LoaiCayTrong||"");let d=document.createElement("td");d.innerText=t.DienTich+""||"0";let h=document.createElement("td");if(t.ThoiGianBatDauTrong){let e=new Date(t.ThoiGianBatDauTrong);h.innerText=`${e.getDate()}/${e.getMonth()+1}/${e.getFullYear()}`}let c=document.createElement("td");if(t.ThoiGianTrongTrot){let e=new Date(t.ThoiGianTrongTrot);c.innerText=`${e.getDate()}/${e.getMonth()+1}/${e.getFullYear()}`}let u=document.createElement("td");u.innerText=t.GiaiDoanSinhTruong,i.appendChild(n),i.appendChild(o),i.appendChild(d),i.appendChild(h),i.appendChild(c),i.appendChild(u)}h.modal("ttModal","Thời gian trồng trọt",i).modal()}else t.update("type","danger"),t.update("message","Không tìm thấy dữ liệu"),t.update("progress",100)})}}}.apply(t,n))||(e.exports=a)},39:function(e,t,i){var n,a,r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();n=[i(0),i(1),i(32),i(31),i(7)],void 0===(a=function(e,t,i,n,a){"use strict";return function(){function i(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(var n in function(e,t){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}(this),this.view=e,this.options={position:"top-left",icon:"esri-icon-user",title:"Người dùng"},t)this.options[n]=t[n];this.isStartup=!1}return i.prototype.startup=function(){this.user&&(this.isStartup||(this.initView(),this.view.ui.add(this.expand,this.options.position),this.isStartup=!0))},i.prototype.destroy=function(){this.isStartup&&(this.view.ui.remove(this.expand),delete this.DOM,delete this.expand,this.isStartup=!1)},i.prototype.initView=function(){var i=this;try{this.DOM={},this.DOM.container=t.create("div",{class:"esri-widget ditagis-widget-user"}),this.DOM.ul=t.create("ul",{},this.DOM.container),t.create("li",{class:"title",innerHTML:this.user.displayName},this.DOM.ul),this.DOM.infoLi=t.create("li",{class:"item"},this.DOM.ul),this.DOM.infoDiv=t.create("div",{class:"container info"},this.DOM.infoLi),this.DOM.setting=t.create("button",{class:"dtg-btn-widget setting",innerHTML:"Cập nhật tài khoản"},this.DOM.infoDiv),e(this.DOM.setting,"click",function(){return i.settingUserClickHandler()}),this.DOM.btnLogout=t.create("button",{class:"dtg-btn-widget btn-logout",innerHTML:"Đăng xuất"},this.DOM.infoDiv),e(this.DOM.btnLogout,"click",function(){return i.logoutClickHandler()}),this.expand=new a({expandIconClass:this.options.icon,expandTooltip:this.options.title,view:this.view,content:this.DOM.container})}catch(e){console.log(e)}},i.prototype.logoutClickHandler=function(){location.href="/account/logout"},i.prototype.successLogout=function(){},i.prototype.failLogout=function(){},i.prototype.settingUserClickHandler=function(){},r(i,[{key:"user",get:function(){return this.view.systemVariable.user}}]),i}()}.apply(t,n))||(e.exports=a)},42:function(e,t,i){var n,a;n=[i,t,i(41),i(30),i(4)],void 0===(a=function(e,t,i,n,a){"use strict";return class extends i{constructor(e){super(e),this.systemVariable=new n}session(){return new Promise((e,t)=>{a("/map",{method:"post"}).then(t=>{this.systemVariable.user=t.data,e(t.data)})})}}}.apply(t,n))||(e.exports=a)},43:function(e,t,i){var n,a;n=[i,t,i(24),i(5),i(3),i(2),i(25),i(28)],void 0===(a=function(e,t,i,n,a,r,o,s){"use strict";return class{constructor(e,t){t=t||{},this.view=e,this.graphics=new s({listMode:"hide"}),this.view.map.add(this.graphics),this.symbolMarker=t.symbolMarker||new n({color:new o([255,0,0]),size:3,outline:new a({width:7,color:new o([255,64,0,.4])})}),this.symbolLine=t.symbolLine||new a({color:new o([255,0,0]),width:4}),this.symbolPlg=t.symbolPlg||new r({style:"none",outline:new a({color:new o([255,64,0,.4]),width:1})})}hightlight(e){this.clear(),this.view.hitTest(e).then(e=>{for(let t of e.results){const e=t.graphic;e.attributes&&null!=e.attributes&&this.add(e)}})}clear(){this.removeAll()}rendererGraphic(e,t){let n;return n="point"===e?this.symbolMarker:"polyline"===e?this.symbolLine:this.symbolPlg,new i({geometry:t,symbol:n})}add(e){const t=e.geometry.type;let i=this.rendererGraphic(t,e.geometry);this.graphics.add(i)}addAll(e){for(let t of e)this.add(t)}removeAll(){this.graphics.removeAll()}}}.apply(t,n))||(e.exports=a)},49:function(e,t,i){var n,a;n=[i,t,i(6),i(4)],void 0===(a=function(e,t,i,n){"use strict";return class{constructor(e={}){this.url=e.url,this.fieldID=e.fieldID||"OBJECTID",this.queryTask=new i(this.url),$.get(this.url+"?f=json").done(e=>{e=JSON.parse(e);for(const t in e)this[t]=e[t]})}findById(e){return this.queryTask.execute({outFields:["*"],where:`${this.fieldID} = '${e}'`})}getFieldDomain(e){return this.fields.find(function(t){return t.name===e}).domain}applyEdits(e={addFeatures:[],updateFeatures:[],deleteFeatures:[]}){let t=document.createElement("form");if(t.method="post",e.addFeatures.length>0){let i=document.createElement("input");i.name="adds",i.type="text",i.value=JSON.stringify(e.addFeatures),t.appendChild(i)}if(e.deleteFeatures.length>0){let i=document.createElement("input");i.name="deletes",i.type="text",i.value=e.deleteFeatures.join(","),t.appendChild(i)}if(e.updateFeatures.length>0){let i=document.createElement("input");i.name="updates",i.type="text",i.value=JSON.stringify(e.updateFeatures),t.appendChild(i)}let i=document.createElement("input");return i.name="f",i.type="text",i.value="json",t.appendChild(i),n(this.url+"/applyEdits?f=json",{method:"post",body:t})}queryFeatures(e){return this.queryTask.execute(e)}}}.apply(t,n))||(e.exports=a)},50:function(e,t,i){var n,a,r=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){e.done?a(e.value):new i(function(t){t(e.value)}).then(o,s)}l((n=n.apply(e,t||[])).next())})};n=[i,t,i(6),i(23)],void 0===(a=function(e,t,i,n){"use strict";return class{static getQueryLocation(e){return this._queryLocation||(this._queryLocation=new i({url:e.map.findLayerById(n.BASEMAP).findSublayerById(n.INDEX_HANHCHINHXA).url})),this._queryLocation}static getLocationName(e,t={PhuongXa:null,HuyenTP:null}){return new Promise((i,n)=>{try{let a=this.getQueryLocation(e),r=[];t.PhuongXa&&r.push(`MaPhuongXa = '${t.PhuongXa}'`),t.HuyenTP&&r.push(`MaHuyenTP = '${t.HuyenTP}'`),a.execute({outFields:["TenXa","TenHuyen"],where:r.join(" and ")}).then(e=>{if(e&&e.features.length>0){let t=e.features[0];t&&t.attributes&&i(t.attributes)}else i(null)})}catch(e){console.log(e),n(e)}})}static getCreatedInfo(e){return{NguoiCapNhat:e.systemVariable.user.userName,NgayCapNhat:(new Date).getTime()}}static getUpdatedInfo(e){return{NguoiCapNhat:e.systemVariable.user.userName,NgayCapNhat:(new Date).getTime()}}static getNhomCayTrong(e,t){return r(this,void 0,void 0,function*(){let i=e.toScreen(t),a=yield e.hitTest(i);if(a.results.length>0){let e=a.results.find(e=>e.graphic.layer.id===n.TRONGTROT);return e&&e.graphic&&e.graphic.attributes?{NhomCayTrong:e.graphic.attributes.NhomCayTrong,LoaiCayTrong:e.graphic.attributes.LoaiCayTrong}:null}return null})}static getLocationInfo(e,t){return new Promise((i,n)=>{try{this.getQueryLocation(e).execute({outFields:["MaPhuongXa","MaHuyenTP"],geometry:t}).then(e=>{if(e&&e.features.length>0){let t=e.features[0];t&&t.attributes&&i(t.attributes)}else i(null)})}catch(e){console.log(e),n(e)}})}}}.apply(t,n))||(e.exports=a)},51:function(e,t,i){var n;void 0===(n=function(e,t){"use strict";return class{constructor(e){this.eventListeners={},e.on=this.on,e.fire=this.fire,e.eventListeners=this.eventListeners}on(e,t){this.eventListeners[e]?this.eventListeners[e].push(t):this.eventListeners[e]=[t]}fire(e,t){let i=this.eventListeners[e];if(i)for(let e of i)e(t)}}}.apply(t,[i,t]))||(e.exports=n)},52:function(e,t,i){var n,a;n=[i,t,i(1),i(40)],void 0===(a=function(e,t,i,n){"use strict";class a{constructor(){this.container=i.toDom('<div class="dtg-tooltip-map"></div>'),n.set(this.container,{position:"fixed"})}static instance(){return this._instance||(this._instance=new a),this._instance}show(e,t){n.set(this.container,{left:`${e[0]+30}px`,top:`${e[1]}px`}),this.container.innerHTML=t,document.body.contains(this.container)||document.body.appendChild(this.container)}hide(){document.body.contains(this.container)&&document.body.removeChild(this.container)}}return a}.apply(t,n))||(e.exports=a)},53:function(e,t,i){var n,a;n=[i,t,i(29)],void 0===(a=function(e,t,i){"use strict";return class{static modal(e,t,n,a){try{let r,o,s,l,d,h,c=i.getBox().w+"px";(r=document.createElement("div")).classList.add("modal","fade"),r.id=e,r.setAttribute("tabindex","-1"),r.setAttribute("role","dialog"),r.setAttribute("aria-labelledby","myModalLabel"),r.setAttribute("aria-hidden","true"),(o=document.createElement("div")).classList.add("modal-dialog"),(s=document.createElement("div")).classList.add("modal-content"),s.style.maxWidth=c,s.style.width="fit-content",(l=document.createElement("div")).classList.add("modal-header");let u=document.createElement("button");u.type="button",u.classList.add("close"),u.setAttribute("data-dismiss","modal"),u.innerHTML='<span aria-hidden="true">×</span><span class="sr-only">Đóng</span>',l.appendChild(u),l.innerHTML+=`<h4 class="modal-title">${t}</h4>`,(d=document.createElement("div")).classList.add("modal-body"),d.appendChild(n),a&&((h=document.createElement("div")).classList.add("modal-footer"),h.appendChild(a)),s.appendChild(l),s.appendChild(d),h&&s.appendChild(h),o.appendChild(s),r.appendChild(o),document.body.appendChild(r);let p=$(`#${e}`);return p?(p.on("hidden.bs.modal",function(){p.remove()}),p):null}catch(e){throw e}}}}.apply(t,n))||(e.exports=a)},54:function(e,t,i){var n,a;n=[i,t,i(27),i(23),i(28),i(24),i(2),i(3),i(33),i(25)],void 0===(a=function(e,t,i,n,a,r,o,s,l,d){"use strict";const h=new o({outline:new s({color:new d("red")})});return class{constructor(e){this.mergeGraphics=new l,this.unionGraphic=null,this.mainGraphic=null,this.view=e.view,this.layer=e.layer,this.initWnd(),this.graphicLayers=new a({listMode:"hide"})}get isRun(){return this._isRun}set isRun(e){e?this.view.ui.add(this.widgetContainer,"top-right"):this.clear(),this._isRun=e}initWnd(){let e=document.createElement("div");e.id="dtg-wget-split-polygon",e.classList.add("esri-widget","esri-widget-button","esri-icon-close-circled"),e.title="Hủy",e.addEventListener("click",this.clear.bind(this)),this.widgetContainer=e}run(e){this.mainGraphic=e,this.isRun=!0,this.graphicLayers.removeAll(),this.mergeGraphics.add(e),this.graphicLayers.add(new r({geometry:e.geometry,symbol:h})),this.view.map.add(this.graphicLayers),this.clickHandler=this.view.on("click",t=>{t.stopPropagation(),this.view.hitTest({x:t.x,y:t.y}).then(t=>{if(t.results.length>0){let i=t.results.find(e=>e.graphic.layer.id===n.TRONGTROT);if(i){if(i.graphic===e)return;this.mergeGraphics.some(e=>e===i.graphic)?this.remove(i.graphic):this.add(i.graphic)}}})}),this.dblClickHandler=this.view.on("double-click",this.dblClickHandlerEvent.bind(this))}add(e){this.graphicLayers.removeAll(),this.mergeGraphics.add(e);let t=i.union(this.mergeGraphics.map(e=>e.geometry).toArray());return this.graphicLayers.add(new r({geometry:t,symbol:h})),this.unionGraphic=t,t}remove(e){this.graphicLayers.removeAll(),this.mergeGraphics.remove(e);let t=i.union(this.mergeGraphics.map(e=>e.geometry).toArray());return this.graphicLayers.add(new r({geometry:t,symbol:h})),this.unionGraphic=t,t}dblClickHandlerEvent(e){if(e.stopPropagation(),confirm("Có chắc chắn ghép thửa?")){Loader.show(!1);let e=this.mergeGraphics.slice(1,this.mergeGraphics.length).map(e=>({objectId:e.attributes.OBJECTID})).toArray(),t=this.mainGraphic.clone();t.geometry=this.unionGraphic,this.layer.applyEdits({updateFeatures:[t],deleteFeatures:e}).then(e=>console.log(e)).always(e=>Loader.hide())}this.clear()}clear(){this.view.ui.remove(this.widgetContainer),this.mainGraphic=null,this.clickHandler&&(this.clickHandler.remove(),delete this.clickHandler),this.graphicLayers.removeAll(),this.view.map.remove(this.graphicLayers),this.mergeGraphics.removeAll(),this.dblClickHandler&&(this.dblClickHandler.remove(),delete this.dblClickHandler)}}}.apply(t,n))||(e.exports=a)},55:function(e,t,i){var n,a,r=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(a,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function s(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){e.done?a(e.value):new i(function(t){t(e.value)}).then(o,s)}l((n=n.apply(e,t||[])).next())})};n=[i,t,i(1),i(0),i(52),i(43),i(2),i(3),i(25),i(24),i(35),i(34),i(27)],void 0===(a=function(e,t,i,n,a,o,s,l,d,h,c,u,p){"use strict";return class{constructor(e,t={}){this.view=e,this.options={position:"top-right",icon:"esri-widget esri-widget-button esri-icon-basemap",icon_cancel:"esri-widget esri-widget-button esri-icon-close-circled",title:"Chia thửa",tooltip:{move:"Nhấn để vẽ đường chia thửa"}},this.initView()}startup(e,t){this.selectedFeature=e,this.layer=t,this.hightlightGraphic.clear(),this.hightlightGraphic.add(e),this.add_dtg_wget_cancel(),this.clickEvent=n(this.view,"click",e=>{this.clickHandler(e)}),this.pointerMoveEvent=n(this.view,"pointer-move",e=>{a.instance().show([e.x,e.y],this.options.tooltip.move),this.pointerMoveHandler(e)}),this.dblClickHandler=n(this.view,"double-click",e=>{e.stopPropagation(),this.finish(e)})}pointerMoveHandler(e){e.stopPropagation();let t={x:e.x,y:e.y},i=this.view.toMap(t);var n=[i.x,i.y],a=[];if(this.vertices.length>0)for(const e of this.vertices)a.push(e);a.push(n),this.refreshMainGraphic(a)}finish(e){const t={x:e.x,y:e.y};let i=this.view.toMap(t);var n=[i.x,i.y];this.vertices.push(n),this.refreshMainGraphic(this.vertices),this.xuly(),this.clearEvent()}xuly(){return r(this,void 0,void 0,function*(){if(confirm("Có chắc chắn tách thửa?")){Loader.show(!1);var e=this.selectedFeature.attributes,t=this.selectedFeature.geometry;let g=new c({paths:this.vertices,spatialReference:this.view.spatialReference}),T=p.cut(t,g);var i=[];for(var n in T){var a=T[n];for(const e of a.rings)i.push(e)}for(var r=yield this.taoMaDoiTuong(),o=[],s=[],l=0;l<i.length;l++){var d=new u({rings:i[l],spatialReference:this.view.spatialReference});if(0==l){const t=new h({geometry:d,attributes:e});o.push(t)}else{var m={};m.LoaiCayTrong=e.LoaiCayTrong,m.OBJECTID=e.OBJECTID,m.MaHuyenTP=e.MaHuyenTP,m.NhomCayTrong=e.NhomCayTrong,m.MaDoiTuong=e.MaDoiTuong+"_"+(r+l);const t=new h({geometry:d,attributes:m});s.push(t)}}let y={updateFeatures:o,addFeatures:s};this.layer.applyEdits(y).always(e=>Loader.hide()),this.vertices=[]}})}taoMaDoiTuong(){return r(this,void 0,void 0,function*(){var e=this.selectedFeature.attributes.MaDoiTuong,t=e.split("_").length;let i=this.layer.createQuery();i.outFields=["MaDoiTuong"],i.where="MaDoiTuong like '"+e+"[_]%'";let n=yield this.layer.queryFeatures(i);var a=0;for(const e of n.features){let i=e.attributes.MaDoiTuong;if(i){var r=i.split("_"),o=parseInt(r[t]);o>a&&(a=o)}}return a})}add_dtg_wget_cancel(){this.view.ui.add(this.DOM.cancel_wget,this.options.position)}initView(){try{this.vertices=[],this.hightlightGraphic=new o(this.view,{symbolPlg:new s({style:"none",outline:new l({color:new d("#0000ff"),width:1})})}),this.DOM={},this.DOM.cancel_wget=i.create("div",{id:"dtg-wget-split-polygon",class:this.options.icon_cancel,title:"Hủy"}),n(this.DOM.cancel_wget,"click",e=>{this.clearEvent()})}catch(e){throw e}}clickHandler(e){e.stopPropagation();const t={x:e.x,y:e.y};let i=this.view.toMap(t);var n=[i.x,i.y];this.vertices.push(n),this.refreshMainGraphic(this.vertices)}refreshMainGraphic(e){try{if(this.graphic&&(this.view.graphics.remove(this.graphic),this.graphic=null),e){let t=new c({paths:e,spatialReference:this.view.spatialReference});this.graphic=new h({geometry:t,symbol:new l({color:new d([255,0,0]),width:1})}),this.view.graphics.add(this.graphic)}}catch(e){console.log(e)}}clearEvent(){this.clickEvent&&(this.clickEvent.remove(),this.clickEvent=null),this.pointerMoveEvent&&(a.instance().hide(),this.pointerMoveEvent.remove(),this.pointerMoveEvent=null),this.dblClickHandler&&(this.dblClickHandler.remove(),this.dblClickHandler=null),this.view.ui.remove(this.DOM.cancel_wget),this.vertices=[],this.hightlightGraphic.clear(),this.graphic&&(this.view.graphics.remove(this.graphic),this.graphic=null)}}}.apply(t,n))||(e.exports=a)},56:function(e,t,i){var n;void 0===(n=function(e,t){"use strict";return class{constructor(e){this.date=e}checkOutOfDate(e){return!((new Date).getTime()-e>0)}checkUnexpired(e){return!this.checkOutOfDate(e)}static formatDateValue(e){if(!e)return"";let t=e.getDate(),i=e.getMonth()+1,n=e.getFullYear();return t/10<1&&(t="0"+t),i/10<1&&(i="0"+i),`${n}-${i}-${t}`}static formatNumberDate(e){if(!e)return"";var t=new Date(e);let i=t.getDate(),n=t.getMonth()+1,a=t.getFullYear();return i/10<1&&(i="0"+i),n/10<1&&(n="0"+n),`${i}/${n}/${a}`}}}.apply(t,[i,t]))||(e.exports=n)},57:function(e,t,i){var n,a;n=[i,t,i(29)],void 0===(a=function(e,t,i){"use strict";return class{static modal(e,t,n,a){try{let r,o,s,l,d,h,c=i.getBox().w+"px";(r=document.createElement("div")).classList.add("modal","fade"),r.id=e,r.setAttribute("tabindex","-1"),r.setAttribute("role","dialog"),r.setAttribute("aria-labelledby","myModalLabel"),r.setAttribute("aria-hidden","true"),(o=document.createElement("div")).classList.add("modal-dialog"),(s=document.createElement("div")).classList.add("modal-content"),s.style.maxWidth=c,s.style.width="fit-content",(l=document.createElement("div")).classList.add("modal-header");let u=document.createElement("button");u.type="button",u.classList.add("close"),u.setAttribute("data-dismiss","modal"),u.innerHTML='<span aria-hidden="true">×</span><span class="sr-only">Đóng</span>',l.appendChild(u),l.innerHTML+=`<h4 class="modal-title">${t}</h4>`,(d=document.createElement("div")).classList.add("modal-body"),d.appendChild(n),a&&((h=document.createElement("div")).classList.add("modal-footer"),h.appendChild(a)),s.appendChild(l),s.appendChild(d),h&&s.appendChild(h),o.appendChild(s),r.appendChild(o),document.body.appendChild(r);let p=$(`#${e}`);return p?(p.on("hidden.bs.modal",function(){p.remove()}),p):null}catch(e){throw e}}}}.apply(t,n))||(e.exports=a)},58:function(e,t,i){var n,a;n=[i,t,i(57),i(56),i(24),i(49),i(0),i(27),i(23),i(26)],void 0===(a=function(e,t,i,n,a,r,o,s,l,d){"use strict";return class{constructor(e){this.view=e.view,this.thoiGianSanXuatTrongTrot=e.table,this.tblGiaiDoanSinhTruong=new r({url:d.tables.find(e=>e.id===l.TBL_GIAI_DOAN_SINH_TRUONG).url,fieldID:"OBJECTID"}),this.dataDetails=[]}get selectFeature(){return this.view.popup.viewModel.selectedFeature}get layer(){return this.view.map.findLayerById(l.TRONGTROT)}get attributes(){return this.selectFeature.attributes}getSubtype(e,t){return e=e||this.layer.typeIdField,t=t||this.attributes[e],this.tblGiaiDoanSinhTruong.typeIdField===e?(this.tblGiaiDoanSinhTruong.typeIdField,this.tblGiaiDoanSinhTruong.types.find(e=>e.id==t)):null}renderDomain(e,t){let i;if("inherited"===e.type){let e=this.layer.getFieldDomain(t);e&&(i=e.codedValues)}else i=e.codedValues;if(!i)return null;let n=this.attributes[t],a=document.createElement("select");a.classList.add("form-control");let r=document.createElement("option");r.value="-1",r.innerText="Chọn giá trị...",a.appendChild(r);for(let e of i){let t=e.code,i=e.name,r=document.createElement("option");r.setAttribute("value",t),n===t&&(r.selected=!0),r.innerHTML=i,a.appendChild(r)}return a}addDetailTrongTrot(){let e,t,n,a,r,l,d,h,c,u,p,m=document.createElement("div");e=document.createElement("div"),(n=document.createElement("div")).classList.add("form-group"),(c=document.createElement("select")).id="LoaiCayTrong",c.classList.add("form-control"),(h=document.createElement("label")).innerText="Loại cây trồng",h.setAttribute("for",c.id),n.appendChild(h),n.appendChild(c),(t=document.createElement("div")).classList.add("form-group"),(p=document.createElement("select")).id="NhomCayTrong",p.classList.add("form-control");let g=this.layer.getFieldDomain("NhomCayTrong").codedValues;for(let e of g){let t=e.code,i=e.name,n=document.createElement("option");n.setAttribute("value",t+""),n.innerHTML=i,p.appendChild(n)}var T=()=>{c.innerHTML="";let e=document.createElement("option");e.value="-1",e.innerText="Chọn giá trị...",c.appendChild(e);let t=this.getSubtype("NhomCayTrong",p.value);if(!t)return;let i,n=t.domains.LoaiCayTrong;if(n){if("inherited"===n.type){let e=this.layer.getFieldDomain("LoaiCayTrong");e&&(i=e.codedValues)}else i=n.codedValues;if(i)for(let e of i){let t=e.code,i=e.name,n=document.createElement("option");n.setAttribute("value",t),n.innerHTML=i,c.appendChild(n)}}};let y,f,v,D,b,C;if(o(p,"change",()=>{T()}),T(),(u=document.createElement("label")).innerText="Nhóm cây trồng",u.setAttribute("for",p.id),t.appendChild(u),t.appendChild(p),(a=document.createElement("div")).classList.add("form-group"),(f=document.createElement("input")).id="DienTich",f.classList.add("form-control"),this.selectFeature.geometry){let e=s.geodesicArea(this.selectFeature.geometry,"square-meters").toFixed(1);f.value=e+""}(y=document.createElement("label")).innerText="Diện tích (m2)",y.setAttribute("for",f.id),a.appendChild(y),a.appendChild(f),(l=document.createElement("div")).classList.add("form-group"),(v=document.createElement("input")).type="date",v.id="ThoiGianTrongTrot",v.classList.add("form-control"),(D=document.createElement("label")).innerText="Thời gian trồng trọt",D.setAttribute("for",v.id),l.appendChild(D),l.appendChild(v),(r=document.createElement("div")).classList.add("form-group"),(b=document.createElement("input")).type="date",b.id="ThoiGianBatDauTrong",b.classList.add("form-control"),(C=document.createElement("label")).innerText="Thời gian bắt đầu trồng",C.setAttribute("for",b.id),r.appendChild(C),r.appendChild(b),(d=document.createElement("button")).classList.add("btn","btn-primary"),d.innerText="Thêm",o(d,"click",()=>{let e={OBJECTID:this.tmpDatasDetailTrongTrong.adds.length+1,MaDoiTuong:this.attributes.MaDoiTuong,NhomCayTrong:parseInt(p.value),LoaiCayTrong:-1==c.value?null:c.value,DienTich:f.value?parseFloat(f.value):0,ThoiGianBatDauTrong:b.value?new Date(b.value):null,ThoiGianTrongTrot:v.value?new Date(v.value):b.value?new Date(b.value):null,GiaiDoanSinhTruong:"Trồng mới"},t=(this.tmpDatasDetailTrongTrong.tableDatas,this.tmpDatasDetailTrongTrong.adds);for(const i of t)if(e.LoaiCayTrong==i.LoaiCayTrong&&e.NhomCayTrong==i.NhomCayTrong&&e.ThoiGianBatDauTrong.getTime()===i.ThoiGianBatDauTrong.getTime())return void alert("Dữ liệu vừa mới thêm - Không được thêm nữa");this.tmpDatasDetailTrongTrong.tableDatas.push(e),this.tmpDatasDetailTrongTrong.adds.push(e),this.addDataToDetailTrongtrot(e),$("#ModalDetail").modal("toggle")}),e.appendChild(t),e.appendChild(n),e.appendChild(a),e.appendChild(r),e.appendChild(l),m.appendChild(e);let w=document.createElement("div");w.appendChild(d),i.modal("ModalDetail","Thêm dữ liệu",m,w).modal()}editDetailTrongTrot(e){let t,a,r,s,l,d,h,c,u,p,m,g,T=document.createElement("div");t=document.createElement("div"),(r=document.createElement("div")).classList.add("form-group"),(p=document.createElement("select")).classList.add("form-control"),(u=document.createElement("label")).innerText="Loại cây trồng",r.appendChild(u),r.appendChild(p),(a=document.createElement("div")).classList.add("form-group"),(g=document.createElement("select")).classList.add("form-control");let y=this.layer.getFieldDomain("NhomCayTrong").codedValues;for(let e of y){let t=e.code,i=e.name,n=document.createElement("option");n.setAttribute("value",t+""),n.innerHTML=i,g.appendChild(n)}g.value=e.NhomCayTrong+"";var f=()=>{p.innerHTML="";let e=document.createElement("option");e.value="-1",e.innerText="Chọn giá trị...",p.appendChild(e);let t=this.getSubtype("NhomCayTrong",g.value);if(!t)return;let i,n=t.domains.LoaiCayTrong;if(n){if("inherited"===n.type){let e=this.layer.getFieldDomain("LoaiCayTrong");e&&(i=e.codedValues)}else i=n.codedValues;if(i)for(let e of i){let t=e.code,i=e.name,n=document.createElement("option");n.setAttribute("value",t),n.innerHTML=i,p.appendChild(n)}}};let v,D,b,C,w,E,L,x;o(g,"change",()=>{f(),N()}),f(),p.value=e.LoaiCayTrong,o(p,"change",e=>{N()}),(m=document.createElement("label")).innerText="Nhóm cây trồng",a.appendChild(m),a.appendChild(g),(s=document.createElement("div")).classList.add("form-group"),(D=document.createElement("input")).type="number",D.value=e.DienTich+"",D.classList.add("form-control"),(v=document.createElement("label")).innerText="Diện tích (m2)",s.appendChild(v),s.appendChild(D),(l=document.createElement("div")).classList.add("form-group"),(b=document.createElement("input")).type="date",b.value=n.formatDateValue(e.ThoiGianTrongTrot),b.classList.add("form-control"),(C=document.createElement("label")).innerText="Thời gian trồng trọt",l.appendChild(C),l.appendChild(b),(d=document.createElement("div")).classList.add("form-group"),(w=document.createElement("input")).type="date",w.value=n.formatDateValue(e.ThoiGianBatDauTrong),w.classList.add("form-control"),(E=document.createElement("label")).innerText="Thời gian bắt đầu trồng",d.appendChild(E),d.appendChild(w),(h=document.createElement("div")).classList.add("form-group"),(L=document.createElement("label")).innerText="Giai đoạn sinh trưởng",(x=document.createElement("select")).classList.add("form-control");let G=document.createElement("option");G.value="Chưa xác định",G.innerText="Chọn giá trị...",G.selected=!0,x.appendChild(G);const N=()=>{x.innerHTML="",x.appendChild(G),this.tblGiaiDoanSinhTruong.queryFeatures({where:`NhomCayTrong = ${g.value} and LoaiCayTrong = '${p.value}'`,outFields:["GiaiDoanSinhTruong"],orderByFields:["MocTG"]}).then(t=>{t.features.forEach(e=>{let t=e.attributes.GiaiDoanSinhTruong,i=document.createElement("option");i.value=i.innerText=t,x.appendChild(i)}),x.value=e.GiaiDoanSinhTruong})};h.appendChild(L),h.appendChild(x),(c=document.createElement("button")).classList.add("btn","btn-primary"),c.innerText="Chấp nhận",o(c,"click",()=>{let t={OBJECTID:e.OBJECTID,NhomCayTrong:parseInt(g.value),LoaiCayTrong:"-1"==p.value?null:p.value,DienTich:D.value?parseFloat(D.value):0,ThoiGianTrongTrot:b.value?new Date(b.value):null,ThoiGianBatDauTrong:w.value?new Date(w.value):null,GiaiDoanSinhTruong:x.value};this.renderEditDetailTrongTrot(t),$("#ModalDetail").modal("toggle")}),t.appendChild(a),t.appendChild(r),t.appendChild(s),t.appendChild(d),t.appendChild(l),t.appendChild(h),T.appendChild(t);let I=document.createElement("div");I.appendChild(c),i.modal("ModalDetail","Sửa dữ liệu",T,I).modal()}showTableDetailTrongTrot(){let e=$.notify({message:"Đang tai dữ liệu..."},{showProgressbar:!0,delay:2e4,placement:{from:"top",align:"left"}});this.tmpDatasDetailTrongTrong={adds:[],edits:[],deletes:[],tableDatas:[],tbody:null},this.dataDetails=[];let t=document.createElement("div"),n=document.createElement("div");n.classList.add("table-responsive");let a=document.createElement("table");a.classList.add("table"),n.appendChild(a);let r=document.createElement("thead");r.innerHTML="<tr>\n          <th>Nhóm cây trồng</th>\n          <th>Loại cây trồng</th>\n          <th>Diện tích (m2)</th>\n          <th>Thời gian trồng trọt</th>\n          <th>Thời gian bắt đầu trồng</th>\n          <th>Giai đoạn sinh trưởng</th>\n          <th>Tác vụ</th>\n        </tr>",a.appendChild(r);let s=document.createElement("tbody");a.appendChild(s),this.tmpDatasDetailTrongTrong.tbody=s;let l=document.createElement("div"),d=document.createElement("button");d.classList.add("btn","btn-default"),d.innerText="Thêm dữ liệu",o(d,"click",()=>{this.addDetailTrongTrot()});let h=document.createElement("button");h.classList.add("btn","btn-primary"),h.innerText="Chấp nhận",o(h,"click",()=>{this.submitDetailTrongtrot(this.tmpDatasDetailTrongTrong)});let c=document.createElement("button");c.type="button",c.classList.add("btn","btn-default"),c.setAttribute("data-dismiss","modal"),c.innerText="Đóng",l.appendChild(h),l.appendChild(d),l.appendChild(c),t.appendChild(n),this.thoiGianSanXuatTrongTrot.findById(this.attributes.MaDoiTuong).then(n=>{n.features.length>0&&n.features.forEach(e=>{let t=e.attributes,i={DienTich:t.DienTich,GiaiDoanSinhTruong:t.GiaiDoanSinhTruong,MaDoiTuong:t.MaDoiTuong,LoaiCayTrong:t.LoaiCayTrong,NhomCayTrong:t.NhomCayTrong,OBJECTID:t.OBJECTID};t.ThoiGianBatDauTrong&&(i.ThoiGianBatDauTrong=new Date(t.ThoiGianBatDauTrong)),t.ThoiGianTrongTrot&&(i.ThoiGianTrongTrot=new Date(t.ThoiGianTrongTrot)),this.tmpDatasDetailTrongTrong.tableDatas.push(i),this.dataDetails.push(e.attributes);let n=this.renderDetailTrongtrot(i);s.appendChild(n)}),i.modal("ttModal","Thời gian trồng trọt",t,l).modal(),e.update("type","success"),e.update("progress",90)})}renderEditDetailTrongTrot(e){try{this.tmpDatasDetailTrongTrong.edits.map(t=>{t.OBJECTID==e.OBJECTID&&this.tmpDatasDetailTrongTrong.edits.splice(this.tmpDatasDetailTrongTrong.edits.indexOf(t))});let t=[];this.tmpDatasDetailTrongTrong.tableDatas.map(i=>{i.OBJECTID==e.OBJECTID?t.push(e):t.push(i)}),this.tmpDatasDetailTrongTrong.tableDatas=t,this.tmpDatasDetailTrongTrong.edits.push(e);let i,a=this.tmpDatasDetailTrongTrong.tbody.getElementsByTagName("tr");for(const t of a){let n=parseInt(t.id);if(n==e.OBJECTID||n==e.ID){i=t;break}}let r=i.getElementsByTagName("td"),o=r[0],s=r[1],l=r[2],d=r[3],h=r[4],c=r[5],u=this.layer.getFieldDomain("NhomCayTrong").codedValues;if(u){let t=u.find(t=>t.code==e.NhomCayTrong);t&&(o.innerText=t.name)}o.innerText||(o.innerText=e.NhomCayTrong+""||"");let p=this.getSubtype("NhomCayTrong",e.NhomCayTrong);if(!p)return;let m=p.domains.LoaiCayTrong;if(m){let t;if("inherited"===m.type){let e=this.layer.getFieldDomain("LoaiCayTrong");e&&(t=e.codedValues)}else t=m.codedValues;if(t){let i=t.find(t=>t.code==e.LoaiCayTrong);i&&(s.innerText=i.name)}}s.innerText||(s.innerText=e.LoaiCayTrong||""),l.innerText=e.DienTich+""||"0",d.innerText=n.formatDateValue(e.ThoiGianTrongTrot),h.innerText=n.formatDateValue(e.ThoiGianBatDauTrong),c.innerText=e.GiaiDoanSinhTruong}catch(e){throw"Có lỗi xảy ra trong quá trình thực hiện"}}renderDetailTrongtrot(e,t=!1){try{let i=document.createElement("tr");i.id=e.OBJECTID||e.ID,t&&i.classList.add("info");let a=document.createElement("td"),r=this.layer.getFieldDomain("NhomCayTrong").codedValues;if(r){let t=r.find(t=>t.code==e.NhomCayTrong);t&&(a.innerText=t.name)}a.innerText||(a.innerText=e.NhomCayTrong+""||"");let s=document.createElement("td"),l=this.getSubtype("NhomCayTrong",e.NhomCayTrong);if(!l)return;let d=l.domains.LoaiCayTrong;if(d){let t;if("inherited"===d.type){let e=this.layer.getFieldDomain("LoaiCayTrong");e&&(t=e.codedValues)}else t=d.codedValues;if(t){let i=t.find(t=>t.code==e.LoaiCayTrong);i&&(s.innerText=i.name)}}s.innerText||(s.innerText=e.LoaiCayTrong||"");let h=document.createElement("td");h.innerText=e.DienTich+""||"0";let c=document.createElement("td");c.innerText=n.formatDateValue(e.ThoiGianTrongTrot);let u=document.createElement("td");u.innerText=n.formatDateValue(e.ThoiGianBatDauTrong);let p=document.createElement("td"),m=document.createElement("td");m.innerText=e.GiaiDoanSinhTruong||"N/A";let g=document.createElement("span");g.classList.add("esri-icon-edit"),o(g,"click",t=>{this.tmpDatasDetailTrongTrong.tableDatas.map(t=>{t.OBJECTID==e.OBJECTID&&this.editDetailTrongTrot(t)})});let T=document.createElement("span");return T.classList.add("esri-icon-trash"),o(T,"click",()=>{e.OBJECTID&&(this.tmpDatasDetailTrongTrong.deletes.push(e.OBJECTID),this.tmpDatasDetailTrongTrong.tableDatas.map(t=>{if(t.OBJECTID==e.OBJECTID){let e=this.tmpDatasDetailTrongTrong.tableDatas.indexOf(t);this.tmpDatasDetailTrongTrong.tableDatas.splice(e,1)}})),this.tmpDatasDetailTrongTrong.tbody.removeChild(i);let t=this.tmpDatasDetailTrongTrong.adds.find(t=>t.OBJECTID==e.OBJECTID);t&&this.tmpDatasDetailTrongTrong.adds.splice(this.tmpDatasDetailTrongTrong.adds.indexOf(t))}),p.appendChild(g),p.appendChild(T),i.appendChild(a),i.appendChild(s),i.appendChild(h),i.appendChild(c),i.appendChild(u),i.appendChild(m),i.appendChild(p),i}catch(e){throw e}}addDataToDetailTrongtrot(e){let t=this.renderDetailTrongtrot(e,!0);this.tmpDatasDetailTrongTrong.tbody.appendChild(t)}submitData(e){let t,i=[];e.tableDatas.map(t=>{e.adds.some(e=>e.OBJECTID==t.OBJECTID)&&i.push(t)}),this.tmpDatasDetailTrongTrong.adds=i,t=e.edits.filter(t=>e.adds.indexOf(t)),this.tmpDatasDetailTrongTrong.edits=t}submitDetailTrongtrot(e){this.submitData(e);let t={addFeatures:[],updateFeatures:[],deleteFeatures:[]};if(e.deletes.length>0&&(t.deleteFeatures=e.deletes),e.adds.length>0)for(let i of e.adds){let e={DienTich:i.DienTich,GiaiDoanSinhTruong:i.GiaiDoanSinhTruong,LoaiCayTrong:i.LoaiCayTrong,MaDoiTuong:i.MaDoiTuong,NhomCayTrong:i.NhomCayTrong};i.ThoiGianBatDauTrong&&(e.ThoiGianBatDauTrong=i.ThoiGianBatDauTrong.getTime()),i.ThoiGianTrongTrot&&(e.ThoiGianTrongTrot=i.ThoiGianTrongTrot.getTime()),t.addFeatures.push({attributes:e})}if(e.edits.length>0)for(let i of e.edits){let e={DienTich:i.DienTich,GiaiDoanSinhTruong:i.GiaiDoanSinhTruong,LoaiCayTrong:i.LoaiCayTrong,MaDoiTuong:i.MaDoiTuong,NhomCayTrong:i.NhomCayTrong,OBJECTID:i.OBJECTID};i.ThoiGianBatDauTrong&&(e.ThoiGianBatDauTrong=i.ThoiGianBatDauTrong.getTime()),i.ThoiGianTrongTrot&&(e.ThoiGianTrongTrot=i.ThoiGianTrongTrot.getTime()),t.updateFeatures.push({attributes:e})}this.thoiGianSanXuatTrongTrot.applyEdits(t).then(t=>{this.refreshNhomCayTrong(this.dataDetails,e.adds),this.tmpDatasDetailTrongTrong=null,this.dataDetails=null}),$("#ttModal").modal("toggle")}refreshNhomCayTrong(e,t){if(0===t.length)return;let i=e.filter(e=>e.NhomCayTrong===this.attributes.NhomCayTrong),n=!1;if(i.length>0){let e={};i.forEach(function(t){let i=t.ThoiGianBatDauTrong;e[i]||(e[i]=[]),e[i].push(t.GiaiDoanSinhTruong)});for(const t in e)if(-1!==e[t].indexOf("Thu hoạch")){n=!0;break}}else n=!0;if(n){let e=t[0];this.layer.applyEdits({updateFeatures:[new a({attributes:{OBJECTID:this.attributes.OBJECTID,NhomCayTrong:e.NhomCayTrong}})]})}}}}.apply(t,n))||(e.exports=a)},59:function(e,t,i){var n,a;n=[i,t,i(23),i(26),i(0),i(1),i(4),i(37),i(22),i(36),i(50),i(58),i(49),i(55),i(54)],void 0===(a=function(e,t,i,n,a,r,o,s,l,d,h,c,u,p,m){"use strict";return class{constructor(e,t){this.view=e,this.options=t,this.locateViewModel=new d({view:e,graphic:null}),this.tblGiaiDoanSinhTruong=new u({url:n.tables.find(e=>e.id===i.TBL_GIAI_DOAN_SINH_TRUONG).url,fieldID:"OBJECTID"}),this.fireFields=["NgayCapNhat","NguoiCapNhat","MaPhuongXa","MaHuyenTP","MaDoiTuong"],this.inputElement={},this.thoiGianSanXuatTrongTrotPopup=new c({view:e,table:t.table}),this.thoiGianSanXuatTrongTrotTbl=t.table,"/congtacvien"!==location.pathname&&(this._splitPolygon=new p(e),this.view.on("layerview-create",t=>{t.layer.id===i.TRONGTROT&&(this._mergePolygon=new m({view:e,layer:t.layer}))}))}get selectFeature(){return this.view.popup.viewModel.selectedFeature}get layer(){return this.selectFeature.layer||this._layer}set layer(e){this.selectFeature.layer||(this._layer=e)}get attributes(){return this.selectFeature.attributes}get objectId(){return this.attributes.OBJECTID}resetInputElement(){this.inputElement={}}isFireField(e){return-1!==this.fireFields.indexOf(e)}getSubtype(e,t){return e=e||this.layer.typeIdField,t=t||this.attributes[e],this.tblGiaiDoanSinhTruong.typeIdField===e?(this.tblGiaiDoanSinhTruong.typeIdField,this.tblGiaiDoanSinhTruong.types.find(e=>e.id==t)):null}renderDomain(e,t){let i;if("inherited"===e.type){let e=this.layer.getFieldDomain(t);e&&(i=e.codedValues)}else i=e.codedValues;if(!i)return null;let n=this.attributes[t],a=document.createElement("select");a.classList.add("form-control");let r=document.createElement("option");r.value="-1",r.innerText="Chọn giá trị...",a.appendChild(r);for(let e of i){let t=e.code,i=e.name,r=document.createElement("option");r.setAttribute("value",t),n===t&&(r.selected=!0),r.innerHTML=i,a.appendChild(r)}return a}showEdit(){let e=this.getSubtype();this.resetInputElement();let t=r.create("div",{id:"show-edit-container",class:"popup-content"}),n=r.create("table",{class:"table"},t);for(let t of this.layer.fields){if("oid"===t.type||this.isFireField(t.name))continue;let i,s=r.create("tr"),h=r.create("td",{innerHTML:t.alias}),c=r.create("td");if(e&&e.domains[t.name])i=this.renderDomain(e.domains[t.name],t.name);else if(t.domain)i=this.renderDomain(t.domain,t.name);else{let e,n;if("small-integer"===t.type||"integer"===t.type||"double"===t.type)e="number";else if("date"===t.type){e="date";var a=new Date(this.attributes[t.name]),o=a.getDate(),l=a.getMonth()+1,d=a.getFullYear();o/10<1&&(o="0"+o),l/10<1&&(l="0"+l),n=`${d}-${l}-${o}`}else e="text";i=length>=this.options.hightLength?r.create("textarea",{rows:5,cols:25,class:"form-control",innerHTML:n||this.attributes[t.name],value:n||this.attributes[t.name]}):r.create("input",{type:e,value:n||this.attributes[t.name],class:"form-control"})}i.name=t.name,r.place(i,c),r.place(h,s),r.place(c,s),r.place(s,n),this.inputElement[t.name]=i,this.registerChangeEvent(i)}this.layer.hasAttachments&&this.layer.getAttachments(this.objectId).then(e=>{let t=r.create("div",{class:"attachment-header",id:`attachment-${this.layer.id}-${this.attributes.OBJECTID}`},document.getElementById("show-edit-container"));t.innerText="Hình ảnh";let i=document.createElement("form");i.id="attachment-data",i.enctype="multipart/form-data",i.method="post";let n=document.createElement("input");n.type="file",n.name="attachment",i.appendChild(n);let a=document.createElement("input");if(a.hidden=!0,a.name="f",a.value="json",i.appendChild(a),t.appendChild(i),this.registerChangeEvent(n),e&&e.attachmentInfos&&e.attachmentInfos.length>0)for(let i of e.attachmentInfos)this.renderAttachmentEditPopup(i,{container:t})});for(let e in this.inputElement)this.inputChangeHandler(this.inputElement[e]);this.view.popup.content=t,this.view.popup.title=this.layer.title;let h=this.view.popup.actions.find(function(e){return"update"===e.id});h.className="esri-icon-check-mark",this.view.popup.actions.add({id:"update-geometry",title:"Cập nhật vị trí đối tượng",className:"esri-icon-locate"});let c=this.view.popup.actions.find(function(e){return"view-detail"===e.id});this.layer.id===i.TRONGTROT&&c&&(c.id="view-detail-edit");var u=()=>{h.className="esri-icon-edit";let e=this.view.popup.actions.find(e=>"update-geometry"===e.id);e&&this.view.popup.actions.remove(e),this.layer.id===i.TRONGTROT&&c&&(c.id="view-detail")};s.once(this.view.popup,"selectedFeature").then(u),s.once(this.view.popup,"visible").then(u)}renderAttachmentEditPopup(e,t){const i=t.container||document.getElementById(`attachment-${this.layer.id}-${this.attributes.OBJECTID}`);let n=`${this.layer.url}/${this.layer.layerId}/${this.attributes.OBJECTID}`,o=r.create("div",{class:"attachment-item"},i),s=r.create("div",{class:"attachment-name"},o);r.create("a",{href:`${n}/attachments/${e.id}`,target:"_blank"},s).innerText=e.name;let l=r.create("div",{class:"delete-attachment esri-icon-trash"},o);a(l,"click",()=>{this.attributes.deleteAttachment||(this.attributes.deleteAttachment=[]),this.attributes.deleteAttachment.push(`${n}/deleteAttachments?f=json&attachmentIds=${e.id}`),i.removeChild(o)})}registerChangeEvent(e){a(e,"change",()=>this.inputChangeHandler(e))}inputChangeHandler(e){const t=e.name,i=e.value;if(!i)return;if(-1==i)return void(this.attributes[t]=null);if("attachment"===t)this.attributes[t]=i;else{const e=this.layer.fields.find(e=>e.name===t);if(e){let n=e.type;if(n){let e;e="small-integer"===n||"integer"===n?parseInt(i):"double"===n?parseFloat(i):i,this.attributes[t]=e}}}let n=this.getSubtype(t);if(n)for(let e in n.domains){let t,i=n.domains[e],a=this.inputElement[e];if(a){if("inherited"===i.type){let i=this.layer.getFieldDomain(e);i&&(t=i.codedValues)}else t=i.codedValues;if("SELECT"===a.tagName){a.innerHTML="";let i=document.createElement("option");i.value="-1",i.innerText="Chọn giá trị...",a.appendChild(i);for(let i of t){let t=document.createElement("option");t.setAttribute("value",i.code),t.innerText=i.name,i.code===this.attributes[e]&&t.setAttribute("selected","selected"),a.appendChild(t)}this.attributes[e]=-1==a.value?null:a.value}else{let i=document.createElement("select");i.classList.add("form-control"),i.setAttribute("name",e);let n=document.createElement("option");n.value="-1",n.innerText="Chọn giá trị...",i.appendChild(n),this.registerChangeEvent(i);for(let e of t){let t=document.createElement("option");t.setAttribute("value",e.code),t.innerText=e.name,i.appendChild(t)}if(a.parentElement){let e=a.parentElement;a.parentElement.removeChild(e.firstChild),e.appendChild(i)}this.attributes[e]=-1==a.value?null:a.value,this.inputElement[e]=i}}}}uploadFile(){let e=this.layer.url+"/"+this.layer.layerId+"/"+this.objectId+"/addAttachment",t=document.getElementById("attachment-data");t&&o(e,{responseType:"json",body:t}).then(e=>{e.data&&e.data.addAttachmentResult&&e.data.addAttachmentResult.success?$.notify({message:"Thêm hình ảnh thành công"},{type:"success",placement:{from:"top",align:"left"}}):$.notify({message:"Thêm hình ảnh không thành công"},{type:"danger",placement:{from:"top",align:"left"}})})}editFeature(){let e=$.notify({title:`<strong>Cập nhật <i>${this.layer.title}</i></strong>`,message:"Cập nhật..."},{showProgressbar:!0,delay:2e4,placement:{from:"top",align:"left"}});try{if(this.attributes){if(this.attributes.attachment&&this.uploadFile(),this.attributes.deleteAttachment){for(let e of this.attributes.deleteAttachment)o(e);this.attributes.deleteAttachment=[]}for(let e of this.layer.fields){const t=e.type,i=e.name;if("date"===t){let e=this.attributes[i];if(e&&!Number.isInteger(e)){let t=e.split("-");if(3!=t.length)throw"Không thể lấy dữ liệu thời gian";{let e=t[2],n=t[1],a=t[0];const r=new Date(`${n}/${e}/${a}`).getTime();this.attributes[i]=r}}}}const t=h.getUpdatedInfo(this.view);for(let e in t)this.attributes[e]=t[e];this.layer.applyEdits({updateFeatures:[{attributes:this.attributes}]}).then(t=>{let i=!1;for(let e of t.updateFeatureResults)if(e.error){i=!0;break}if(!i){e.update("type","success"),e.update("message","Cập nhật thành công!"),e.update("progress",90);let t=this.layer.createQuery();t.outFields=["*"],t.where="OBJECTID="+this.attributes.OBJECTID,this.layer.queryFeatures(t).then(e=>{this.view.popup.open({features:e.features})})}})}}catch(t){throw e.update("type","danger"),e.update("message","Có lỗi xảy ra trong quá trình cập nhật!"),e.update("progress",90),t}}deleteFeature(){if(!confirm("Chắc chắn muốn xóa?"))return;let e=this.objectId,t=$.notify({title:`<strong>Xóa <i>${this.layer.title}</i></strong>`,message:"Đang xóa..."},{showProgressbar:!0,delay:2e4});this.layer.applyEdits({deleteFeatures:[{objectId:e}]}).then(e=>{e.deleteFeatureResults.length>0&&!e.deleteFeatureResults[0].error&&(this.view.popup.visible=!1,t.update("type","success"),t.update("message","Xóa thành công!"),t.update("progress",100))})}splitPolygon(){this.view.popup.visible=!1,this._splitPolygon.startup(this.selectFeature,this.layer)}mergePolygon(){this.view.popup.visible=!1,this._mergePolygon.run(this.selectFeature)}updateGeometryGPS(){let e=this.objectId,t=$.notify({title:"<strong>Cập nhật vị trí</strong>",message:"Cập nhật..."},{showProgressbar:!0,delay:2e4,placement:{from:"top",align:"left"}});this.locateViewModel.locate().then(i=>{const n=i.coords,a=n.latitude,r=n.longitude,o=new l({latitude:a,longitude:r,spatialReference:this.view.spatialReference});this.layer.applyEdits({updateFeatures:[{attributes:{objectId:e},geometry:o}]}).then(e=>{e.updateFeatureResults[0].error?(t.update("type","danger"),t.update("message","Cập nhật không thành công!"),t.update("progress",90)):(t.update("type","success"),t.update("message","Cập nhật thành công!"),t.update("progress",90),this.view.popup.close())})})}showTableDetailTrongTrot(){this.thoiGianSanXuatTrongTrotPopup.showTableDetailTrongTrot()}}}.apply(t,n))||(e.exports=a)}}]);